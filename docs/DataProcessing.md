# 문서 처리 파이프라인 상세 설계

## 1. 목표

RIS 전략 문서(PDF)의 내용을 **손실이나 왜곡 없이** 구조적으로 추출하여 RAG 성능을 극대화합니다. 텍스트, 표, 이미지를 개별적으로 인식하고 유의미한 메타데이터와 함께 처리하는 것을 목표로 합니다.

## 2. 처리 단계

본 파이프라인은 다양한 문서 형식을 처리할 수 있도록 설계되었습니다. 핵심 파서로 `unstructured.io`를 사용하여 파일 유형을 자동으로 감지하고 적절한 로더를 동적으로 선택합니다. 특정 파일 형식(예: PDF)의 경우, 더 정교한 메타데이터 추출을 위해 `PyMuPDF`와 같은 전문 라이브러리를 함께 사용할 수 있습니다.

### 단계 1: 문서 로드 및 유형 식별 (Document Loading & Type Identification)

- `unstructured.io`를 사용하여 업로드된 파일(PDF, DOCX, TXT 등)을 로드합니다. `unstructured`는 내부적으로 파일 확장자를 기반으로 최적의 파서를 사용합니다.
- PDF 파일의 경우, `PyMuPDF`를 보조적으로 사용하여 페이지별 이미지나 특정 영역의 좌표 등 더 상세한 메타데이터를 추출할 수 있습니다.

### 단계 2: 레이아웃 분석 (Layout Analysis)

- `unstructured.io` 라이브러리를 활용하여 각 페이지의 레이아웃을 분석합니다.
- 이를 통해 텍스트 블록, 표, 이미지 영역을 구분합니다. `unstructured`는 HTML과 유사한 형태로 구조를 반환하여 후처리에 용이합니다.

### 단계 3: 표(Table) 추출 및 변환

- `unstructured`가 식별한 표 영역을 추출합니다.
- 추출된 표는 LLM이 쉽게 이해할 수 있도록 **Markdown 형식으로 변환**합니다.
- 변환된 Markdown 표는 원본 텍스트와 별도로, 'type: table'과 같은 메타데이터와 함께 저장됩니다.

### 단계 4: 이미지(Image) 처리

- **옵션 A (Image Captioning):**
  - 페이지에서 식별된 이미지를 파일로 추출합니다.
  - `Jemini`와 같은 멀티모달 LLM을 사용하여 이미지에 대한 설명을 생성합니다.
  - 생성된 캡션을 'type: image_summary' 메타데이터와 함께 텍스트 데이터로 저장합니다.
- **옵션 B (Multimodal RAG - 심화):**
  - 이미지를 텍스트가 아닌 이미지 자체로 다룰 수 있는 멀티모달 모델(e.g., Jemini)을 활용하는 아키텍처를 고려합니다. 이 경우, 이미지와 텍스트 임베딩을 함께 처리하는 복잡한 로직이 필요합니다. (초기 단계에서는 옵션 A를 우선 적용)

### 단계 5: 청킹 (Chunking)

- `RecursiveCharacterTextSplitter`를 사용하여 텍스트와 변환된 표(Markdown)를 청크로 분할합니다.
- 청킹 시, 논리적인 문단이 나뉘지 않도록 적절한 `chunk_size`와 `chunk_overlap`을 설정합니다.
- 각 청크는 **다음과 같은 풍부한 메타데이터를 포함**해야 합니다.
  ```json
  {
    "source_doc_id": "...",
    "page_number": 5,
    "content_type": "text" // or "table", "image_summary"
  }
  ```

## 3. 최종 데이터 구조

벡터 저장소에 저장되는 각 문서는 단순한 텍스트 조각이 아닌, 위와 같은 구조화된 메타데이터를 포함한 객체가 됩니다. 이를 통해 검색 시 더 정교한 필터링과 컨텍스트 제공이 가능해집니다.

## 4. 알려진 한계점 및 도전 과제

- **스캔된 PDF 문서**: 현재 파이프라인은 텍스트 기반의 PDF에 최적화되어 있습니다. 이미지로만 이루어진 스캔된 PDF를 처리하기 위해서는 OCR(광학 문자 인식, e.g., Tesseract, Naver CLOVA OCR) 기술을 파이프라인에 추가로 통합해야 합니다.
- **암호화된 파일**: 암호로 보호된 문서는 현재 처리할 수 없으며, 업로드 시 에러를 반환합니다.
- **복잡한 표 구조**: 두 개 이상의 행이나 열이 병합된 복잡한 구조의 표는 Markdown으로 변환 시 구조가 일부 손실될 수 있습니다.
- **한글 파일(HWP) 지원**: `unstructured.io`는 한글 파일(.hwp)을 기본적으로 지원하지 않을 수 있습니다. HWP 파일 처리가 필수 요구사항일 경우, 별도의 전용 파서를 구현하거나 찾아야 합니다.
