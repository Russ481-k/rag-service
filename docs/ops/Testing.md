# 테스트 전략

본 문서는 RAG 서비스의 안정성과 코드 품질을 보장하기 위한 테스트 전략을 정의합니다. 우리는 테스트 주도 개발(TDD)을 지향하며, 코드 작성과 테스트 작성을 병행합니다.

## 1. 테스트의 종류와 범위

- **단위 테스트 (Unit Tests)**:

  - **목표**: 단일 함수나 클래스 같은 가장 작은 코드 단위의 정확성을 검증합니다.
  - **범위**: 외부 의존성(DB, 외부 API, 파일 시스템) 없이 순수한 로직을 테스트합니다. `pytest`와 `unittest.mock`을 사용합니다.
  - **예시**: Pydantic 스키마 유효성 검사, 서비스 계층의 순수 비즈니스 로직 함수.

- **통합 테스트 (Integration Tests)**:

  - **목표**: 여러 컴포넌트가 함께 올바르게 동작하는지 검증합니다.
  - **범위**: API 엔드포인트부터 서비스 계층, 데이터베이스까지의 상호작용을 테스트합니다. 실제 DB나 외부 API 대신 테스트용 DB와 Mock 서버를 사용합니다.
  - **예시**: `/upload` API 호출 시 파일이 처리되고 상태가 DB에 정상적으로 기록되는지 검증.

- **종단간 테스트 (End-to-End Tests)**:
  - **목표**: 실제 사용자의 시나리오를 시뮬레이션하여 전체 시스템이 정상적으로 동작하는지 검증합니다.
  - **범위**: 실제 배포된 환경이나 그와 유사한 스테이징 환경에서 실행됩니다.
  - **예시**: 사용자가 문서를 업로드하고, 상태를 확인한 뒤, 해당 문서에 대해 질문하고 답변을 받는 전체 흐름을 테스트합니다.

## 2. 테스트 실행

```bash
# 모든 테스트 실행
poetry run pytest

# 특정 파일 테스트 실행
poetry run pytest tests/test_services.py

# 특정 테스트 함수 실행
poetry run pytest tests/test_api.py::test_upload_file
```

## 3. Mocking 전략

- **외부 API (Jemini, Supabase)**: `unittest.mock`의 `patch`나 `pytest-mock`의 `mocker`를 사용하여 외부 API 클라이언트의 메서드를 모의(Mock) 처리합니다. 이를 통해 외부 서비스의 상태와 비용에 관계없이 안정적인 테스트가 가능합니다.
- **Celery**: Celery는 테스트를 위한 `task_always_eager` 설정을 제공합니다. 이 설정을 `True`로 두면, 비동기 작업이 백그라운드 워커가 아닌 현재 스레드에서 즉시 동기적으로 실행되어 테스트 코드 내에서 결과를 바로 확인할 수 있습니다.
